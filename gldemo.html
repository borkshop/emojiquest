<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=0.5" />
  <link rel="stylesheet" type="text/css" href="index.css" />
  <title>Cube</title>
</head>

<body>

  <div style="position: absolute; right: 0">

  </div>

  <canvas id="world"></canvas>

  <script type="module">
    import demo from './gldemo.js';

    const $world = document.querySelector('canvas#world');
    if (!$world) throw new Error('unable to find world canvas');

    let halt = true;
    let stop = () => { };

    window.addEventListener('keypress', e => {
      switch (e.key) {
        case 'q':
        case 'Q':
          if (halt) {
            run();
          } else {
            halt = true;
            stop();
          }
          break;

        case '.':
          stop();
          break;

      }
    });

    async function run() {
      if (!halt) return;
      halt = false;
      for (
        let count = 0, backoff = 0, now = Date.now(), then = now;
        !halt;
        then = now,
        backoff = Math.min(200, Math.pow(1.5, ++count))
      ) {
        const since = now - then;
        const wait = backoff - since;
        if (wait > 0)
          await new Promise(resolve => setTimeout(resolve, wait));
        count = 0;

        let done;
        ({stop, done} = await demo({
          $world,
          cellSize: 100,
          tileSize: 256,

          worldWidth: 8,
          worldHeight: 8,
          showCurvyTiles: true,

        }));
        await done;
      }
    }

    run();
  </script>
</body>

</html>
